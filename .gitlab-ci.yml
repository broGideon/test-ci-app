stages:
  - lint
  - test
  - security
  - build

.default_pnpm_job:
  image: node:22-alpine
  tags: [docker-runner]
  cache:
    key:
      files:
        - pnpm-lock.yaml
      prefix: pnpm
    paths:
      - .pnpm-store/
  before_script:
    - corepack enable
    - corepack prepare pnpm@9.15.5 --activate
    - pnpm config set store-dir "$CI_PROJECT_DIR/.pnpm-store"
    - pnpm install --frozen-lockfile --prod=false

lint:
  stage: lint
  extends: .default_pnpm_job
  script:
    - pnpm lint:ci
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - eslint-report.json

test:
  stage: test
  extends: .default_pnpm_job
  script:
    - pnpm test:ci
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - junit.xml
      - coverage

security:
  stage: security
  extends: .default_pnpm_job
  script:
    - pnpm audit --audit-level=moderate --json > pnpm-audit.json || true
  allow_failure: true
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - pnpm-audit.json

build:
  stage: build
  extends: .default_pnpm_job
  script:
    - pnpm build
  artifacts:
    when: on_success
    expire_in: 14 days
    paths:
      - dist/